<html>
<head>
    <style>
    body {
        padding: 0;
        margin: 0;
    }
    html, body, #map {
        height: 100%;
        width: 100vw;
    }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
         integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
         crossorigin=""/>
     <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
         integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
         crossorigin=""></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
</head>

<body>
    <div id="map"></div>
    <script>
        var map = L.map('map').fitWorld();
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);
        map.locate({setView: true, maxZoom: 16});

        function onLocationError(e) {
            map.setView([47.6740, -122.1215], 12)
        }

        map.on('locationerror', onLocationError);

        async function getData() {
            const response = await fetch("https://raw.githubusercontent.com/richardsondev/pse-outages/refs/heads/main/outages.json");
            const mapData = await response.json();

            for (mapItem of mapData.PseMap) {
                let status = "";

                let popupText = "";
                for (attribute of mapItem.DataProvider.Attributes) {
                    popupText += attribute.Name + ": " + attribute.Value + "<br />";
                    if (attribute.Name === "Status") {
                        status = attribute.Value;
                    }
                }

                let coordinates = [];
                for (let coordinate of mapItem.Polygon) {
                    coordinates.push([coordinate.Latitude, coordinate.Longitude]);
                }

                let colors = {
                    "Outage reported": "red",
                    "Assessing damage": "orange",
                    "Crew assigned": "yellow",
                    "Repair crew onsite": "green",
                    "": "blue",
                }

                let polygon = L.polygon(coordinates, {color: colors[status] || "purple", opacity: 0.5, fillOpacity: 0.2}).addTo(map);

                let poi = mapItem.DataProvider.PointOfInterest;
                L.marker([poi.Latitude, poi.Longitude])
                    .bindPopup(popupText)
                    .on("popupopen", () => {
                        polygon.setStyle({opacity: 1.0, fillOpacity: 0.75});
                        
                    })
                    .on("popupclose", () => {
                        polygon.setStyle({opacity: 0.5, fillOpacity: 0.2});
                    })
                    .addTo(map);
            }
        }

        getData();
    </script>
</body>
</html>
