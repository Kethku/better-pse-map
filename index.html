<html>
<head>
    <style>
    body {
        padding: 0;
        margin: 0;
    }
    html, body, #map {
        height: 100%;
        width: 100vw;
    }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
         integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
         crossorigin=""/>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.7.2/build/global/luxon.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
         integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
         crossorigin=""></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js" charset="utf-8"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
</head>

<body>
    <div id="map"></div>
    <script>
        var DateTime = luxon.DateTime;
        var map = L.map('map').fitWorld();
        let locate = L.control.locate().addTo(map);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        map.on("moveend zoomend", () => {
            const center = map.getCenter();
            localStorage.setItem("mapView", JSON.stringify({
                lat: center.lat,
                lng: center.lng,
                zoom: map.getZoom(),
            }));
        });

        const savedView = JSON.parse(localStorage.getItem("mapView"));
        const startLat = savedView?.lat ?? 47.6740;
        const startLng = savedView?.lng ?? -122.1215;
        const startZoom = savedView?.zoom ?? 13;

        map.setView([startLat, startLng], startZoom);

        async function getData() {
            const commitsResponse = await
                fetch("https://api.github.com/repos/richardsondev/pse-outages/commits?path=outages.json&per_page=5");
            const commits = await commitsResponse.json();

            for (commit of commits) {
                try {
                    const dataResponse = await fetch("https://raw.githubusercontent.com/richardsondev/pse-outages/" +
                        commit.sha + "/outages.json");
                    const data = await dataResponse.json();
                    if (data) {
                        localStorage.setItem("mapData", JSON.stringify(data));
                        return data;
                    }
                } catch (error) {
                    console.log("Error fetching data for commit " + commit.sha + ": " + error);
                }
            }

            console.log("No valid data found in recent commits. Falling back to cached data.");
            let mapData = localStorage.getItem("mapData");
            if (mapData) {
                return mapData;
            }
            return null;
        }

        async function addDataToMap() {
            const mapData = await getData();
            if (!mapData) {
                console.log("No map data available.");
                return;
            }

            let pointsOfInterest = [];

            for (mapItem of mapData.PseMap) {
                let status = "";

                let popupText = "";
                for (attribute of mapItem.DataProvider.Attributes) {
                    if (attribute.Name === "Status") {
                        status = attribute.Value;
                    }

                    let value = attribute.Value;
                    let dt = DateTime.fromFormat(attribute.Value, "M/d h:mm a");

                    if (dt.isValid) {
                        value = dt.toRelative() + " (" + attribute.Value + ")";

                    }

                    popupText += attribute.Name + ": " + value + "<br />";
                }

                let coordinates = [];
                for (let coordinate of mapItem.Polygon) {
                    coordinates.push([coordinate.Latitude, coordinate.Longitude]);
                }

                let colors = {
                    "Outage reported": "red",
                    "Assessing damage": "orange",
                    "Crew assigned": "yellow",
                    "Repair crew onsite": "green",
                    "": "gray",
                }

                let polygon = L.polygon(coordinates, {color: colors[status] || "blue", opacity: 0.5, fillOpacity: 0.2}).addTo(map);

                let poi = mapItem.DataProvider.PointOfInterest;
                let poiCoordinate = [poi.Latitude, poi.Longitude];
                L.marker(poiCoordinate)
                    .bindPopup(popupText)
                    .on("popupopen", () => {
                        polygon.setStyle({opacity: 1.0, fillOpacity: 0.75});
                        
                    })
                    .on("popupclose", () => {
                        polygon.setStyle({opacity: 0.5, fillOpacity: 0.2});
                    })
                    .addTo(map);

                pointsOfInterest.push(poiCoordinate);
            }

            const poiBounds = L.latLngBounds(pointsOfInterest);
            if (!poiBounds.contains(map.getBounds())) {
                map.fitBounds(poiBounds);
            }
        }

        addDataToMap();
    </script>
</body>
</html>
